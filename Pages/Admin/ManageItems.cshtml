@page
@model LostAndFoundWebApp.Pages.Admin.ManageItemsModel
@{
    ViewData["Title"] = "物品管理";
}

<h1>物品管理</h1>
<form method="post">
    @Html.AntiForgeryToken()
</form>
<table class="table">
    <thead>
        <tr>
            <th>物品ID</th>
            <th>名称</th>
            <th>位置</th>
            <th>状态</th>
            <th>操作</th>
        </tr>
    </thead>
    <tbody id="itemTableBody">
        @foreach (var item in Model.Items)
        {
            <tr id="itemRow-@item.ItemId" class="item-row" data-item-id="@item.ItemId">
                <td>@item.ItemId</td>
                <td>@item.Name</td>
                <td>@item.Location</td>
                <td id="itemStatus-@item.ItemId">
                @if (item.Status == LostAndFoundWebApp.Models.ItemMetadata.Status.Lost)
                {
                    @((item.IsValid == true) ? "待找回" : "已找回")
                }
                else if (item.Status == LostAndFoundWebApp.Models.ItemMetadata.Status.Found)
                {
                    @((item.IsValid == true) ? "待认领" : "已认领")
                }
                </td>
                <td>
                @if (item.IsValid == true)
                {
                    <button class="btn btn-sm btn-primary toggle-status-btn" data-item-id="@item.ItemId">
                        标记为已处理
                    </button>
                }
                else
                {
                    <button class="btn btn-sm btn-secondary" disabled>已处理</button>
                }
                </td>
            </tr>
            <tr id="imageRow-@item.ItemId" class="image-row" style="display: none;">
                <td colspan="5">
                    <div class="image-container" id="imageContainer-@item.ItemId">
                        <p>加载中...</p> <!-- 占位符 -->
                    </div>
                </td>
            </tr>
        }
    </tbody>
</table>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const buttons = document.querySelectorAll('.toggle-status-btn');
            buttons.forEach(button => {
                button.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const itemId = e.target.getAttribute('data-item-id');
                    const tokenElement = document.querySelector('input[name="__RequestVerificationToken"]');

                    if (!tokenElement) {
                        console.error('防伪令牌未找到，请确保页面包含 @Html.AntiForgeryToken()。');
                        alert('请求失败：防伪令牌未找到。');
                        return;
                    }

                    const token = tokenElement.value;

                    try {
                        const response = await fetch(`/Admin/ManageItems?handler=Toggle`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'RequestVerificationToken': token
                            },
                            body: JSON.stringify({ itemId: parseInt(itemId) })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            const statusCell = e.target.closest('tr').querySelector('td:nth-child(4)');
                            const actionCell = e.target.closest('td');

                            // 更新状态
                            if (result.isLostItem) {
                                statusCell.textContent = result.isValid ? "待找回" : "已找回";
                            } else{
								statusCell.textContent = result.isValid ? "待认领" : "已认领";
                            }

                            // 替换操作按钮
                            if (!result.isValid) {
                                actionCell.innerHTML = '<button class="btn btn-sm btn-secondary" disabled>已处理</button>';
                            }
                        } else {
                            alert('更新失败，请稍后重试。');
                        }
                    } catch (error) {
                        console.error('请求失败:', error);
                        alert('请求失败，请检查网络连接。');
                    }
                });
            });

            const rows = document.querySelectorAll('.item-row');
            rows.forEach(row => {
                row.addEventListener('click', async () => {
                    const itemId = row.getAttribute('data-item-id');
                    const imageRow = document.getElementById(`imageRow-${itemId}`);
                    const imageContainer = document.getElementById(`imageContainer-${itemId}`);

                    if (imageRow.style.display === 'none') {
                        imageRow.style.display = 'table-row';

                        // 如果图片尚未加载，则从服务器获取
                        if (!imageContainer.dataset.loaded) {
                            try {
                                const response = await fetch(`/Admin/ManageItems?handler=GetImages&itemId=${itemId}`);
                                if (response.ok) {
                                    const images = await response.json();
                                    imageContainer.innerHTML = ''; // 清空占位符
                                    if (images.length > 0) {
                                        images.forEach(image => {
                                            const img = document.createElement('img');
                                            img.src = image.imagePath;
                                            img.alt = '物品图片';
                                            img.className = 'thumbnail';
                                            imageContainer.appendChild(img);
                                        });
                                    } else {
                                        imageContainer.innerHTML = '<p>没有图片</p>';
                                    }
                                    imageContainer.dataset.loaded = true; // 标记为已加载
                                } else {
                                    imageContainer.innerHTML = '<p>加载图片失败</p>';
                                }
                            } catch (error) {
                                console.error('加载图片失败:', error);
                                imageContainer.innerHTML = '<p>加载图片失败</p>';
                            }
                        }
                    } else {
                        imageRow.style.display = 'none';
                    }
                });
            });
        });
    </script>
}
